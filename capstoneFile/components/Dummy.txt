// ... keep your existing imports
import { View, Text, TouchableOpacity, Image, TextInput, Modal } from 'react-native';
import React, { useState } from 'react';
import { Ionicons } from '@expo/vector-icons';
import { LinearGradient } from 'expo-linear-gradient';
import { DataTable } from 'react-native-paper';
import { Picker } from '@react-native-picker/picker';
import * as ImagePicker from 'expo-image-picker';
import homeStyle from '../styles/HomeStyle';

export default function HomePage() {
  // existing states...
  const [editAccountVisible, setEditAccountVisible] = useState(false);
  const [selectedUser, setSelectedUser] = useState(null);

  // handler to open edit modal
  const handleEditAccount = (user) => {
    setSelectedUser(user);
    setEditAccountVisible(true);
  };

  // handler to save edited account
  const handleSaveEditAccount = () => {
    if (!selectedUser) return;

    setUsers(users.map(u => u.id === selectedUser.id ? selectedUser : u));
    setEditAccountVisible(false);
    setSelectedUser(null);
  };

  // pick image for edit
  const pickEditImage = async () => {
    const permissionResult = await ImagePicker.requestMediaLibraryPermissionsAsync();
    if (!permissionResult.granted) {
      alert("Permission to access camera roll is required!");
      return;
    }

    let result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      allowsEditing: true,
      aspect: [4, 4],
      quality: 1,
    });

    if (!result.canceled) {
      setSelectedUser({ ...selectedUser, image: result.assets[0].uri });
    }
  };

  return (
    <View style={homeStyle.biContainer}>
      {/* ... your existing layout */}

      <DataTable>
        <DataTable.Header style={homeStyle.tableHeader}>
          {/* ... headers */}
        </DataTable.Header>

        {filteredUsers.map(user => (
          <DataTable.Row key={user.id}>
            {/* ... other cells */}
            <DataTable.Cell style={{ justifyContent: 'flex-end' }}>
              <TouchableOpacity onPress={() => handleEditAccount(user)}>
                <Ionicons name="pencil-sharp" size={15} color="#3d67ee" />
              </TouchableOpacity>
            </DataTable.Cell>
          </DataTable.Row>
        ))}
      </DataTable>

      {/* EDIT ACCOUNT OVERLAY */}
      <Modal
        visible={editAccountVisible}
        transparent={true}
        animationType="fade"
        onRequestClose={() => setEditAccountVisible(false)}
      >
        <View style={{flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.5)'}}>
          <View style={homeStyle.modalContainer}>
            <View style={{marginBottom: 20, alignItems: 'center'}}>
              <Text style={{ fontSize: 24, fontWeight: 'bold', fontFamily: 'Segoe UI' }}>Edit Account</Text>
            </View>

            {selectedUser && (
              <>
                <View style={{ alignItems: 'center', marginBottom: 35 }}> 
                  <TouchableOpacity 
                    style={[ homeStyle.uploadBtn, { justifyContent: 'center', alignItems: 'center', position: 'relative' } ]} 
                    onPress={pickEditImage} 
                  >
                    {selectedUser.image ? (
                      <Image 
                        source={{ uri: selectedUser.image }} 
                        style={{ width: 100, height: 100, borderRadius: 60, borderWidth: 1, borderColor: '#3d67ee' }} 
                      />
                    ) : (
                      <View style={{ alignItems: 'center' }}>
                        <Ionicons name="image-outline" size={18} color="#3d67ee" style={{ marginTop: 2 }} />
                        <Text style={{ color: '#3d67ee', fontSize: 11 }}>Upload Image</Text>
                      </View>
                    )}
                    <View 
                      style={{
                        position: 'absolute',
                        bottom: 0,
                        right: 0,
                        backgroundColor: '#3d67ee',
                        borderRadius: 25,
                        borderWidth: 1,
                        borderColor: '#3d67ee',
                        padding: 4,
                      }}
                    >
                      <Ionicons name="camera" size={16} color="#ffffff" />
                    </View>
                  </TouchableOpacity>
                </View>

                {/* Editable fields */}
                <View style={homeStyle.modalSections}>
                  <View style={homeStyle.leftModalSection}>
                    <Text style={homeStyle.labelStyle}>Full Name</Text>
                    <TextInput
                      style={homeStyle.textInputStyle}
                      value={selectedUser.name}
                      onChangeText={(text) => setSelectedUser({ ...selectedUser, name: text })}
                    />

                    <Text style={homeStyle.labelStyle}>Contact Number</Text>
                    <TextInput
                      style={homeStyle.textInputStyle}
                      value={selectedUser.contact}
                      onChangeText={(text) => setSelectedUser({ ...selectedUser, contact: text })}
                    />

                    <View style={{ alignItems: "flex-end" }}>
                      <TouchableOpacity
                        style={[homeStyle.blackBtn, {width: "50%", alignItems:"center", marginTop: 25, padding: 20, backgroundColor: '#dad8d8'}]}
                        onPress={() => setEditAccountVisible(false)}
                      >
                        <Text style={{ color: '#0c0c0c', fontSize: 14, fontWeight: '600' }}>Cancel</Text>
                      </TouchableOpacity>
                    </View>
                  </View>

                  <View style={homeStyle.rightModalSection}>
                    <Text style={homeStyle.labelStyle}>E-Mail</Text>
                    <TextInput
                      style={homeStyle.textInputStyle}
                      value={selectedUser.email}
                      onChangeText={(text) => setSelectedUser({ ...selectedUser, email: text })}
                    />

                    <Text style={homeStyle.labelStyle}>Role</Text>
                    <Picker
                      selectedValue={selectedUser.role}
                      onValueChange={(val) => setSelectedUser({ ...selectedUser, role: val })}
                      style={homeStyle.createPickerStyle}
                    >
                      <Picker.Item label="Admin" value="Admin" />
                      <Picker.Item label="User" value="User" />
                      <Picker.Item label="Moderator" value="Moderator" />
                    </Picker>

                    <Text style={homeStyle.labelStyle}>Department</Text>
                    <Picker
                      selectedValue={selectedUser.department}
                      onValueChange={(val) => setSelectedUser({ ...selectedUser, department: val })}
                      style={homeStyle.createPickerStyle}
                    >
                      <Picker.Item label="Marketing" value="Marketing" />
                      <Picker.Item label="Sales" value="Sales" />
                      <Picker.Item label="IT" value="IT" />
                      <Picker.Item label="Human Resources" value="Human Resources" />
                    </Picker>

                    <TouchableOpacity onPress={handleSaveEditAccount}>
                      <LinearGradient
                        colors={['#3d67ee', '#0738D9', '#041E76']}
                        start={{ x: 0, y: 0 }}
                        end={{ x: 1, y: 1 }}
                        style={[homeStyle.blackBtn, {width: "50%", alignItems:"center", marginTop: 28, gap: 10, padding: 20}]}
                      >
                        <Text style={{ color: '#ffffff', fontSize: 14, fontWeight: '600' }}>Save Changes</Text>  
                      </LinearGradient>
                    </TouchableOpacity>
                  </View>
                </View>
              </>
            )}
          </View>
        </View>
      </Modal>
      {/* END OF EDIT ACCOUNT OVERLAY */}
    </View>
  );
}
